name: Release Electron App

on:
   push:
      branches:
         - main

jobs:
   release:
      permissions:
         contents: write
      # Run only if commit message contains [bump-version]
      if: contains(github.event.head_commit.message, '[bump-version]')
      runs-on: macos-latest

      steps:
         - name: Checkout code
           uses: actions/checkout@v4

         - name: Setup Node.js
           uses: actions/setup-node@v4
           with:
              node-version: "18"
              cache: "yarn"

         - name: Install dependencies
           run: yarn install --frozen-lockfile

         - name: Get version from package.json
           id: get-version
           run: |
              VERSION=$(node -p "require('./package.json').version")
              echo "version=$VERSION" >> $GITHUB_OUTPUT

         - name: Build macOS app
           run: yarn build:mac

         - name: Create Git Tag
           run: |
              git tag v${{ steps.get-version.outputs.version }}
              git push origin v${{ steps.get-version.outputs.version }}

         - name: Create Release
           id: create_release
           uses: actions/create-release@v1
           env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
           with:
              tag_name: v${{ steps.get-version.outputs.version }}
              release_name: Release v${{ steps.get-version.outputs.version }}
              draft: false
              prerelease: false

         - name: Upload Release Asset
           uses: actions/upload-release-asset@v1
           env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
           with:
              upload_url: ${{ steps.create_release.outputs.upload_url }}
              asset_path: ./dist/your-app-name.dmg
              asset_name: YourApp-${{ steps.get-version.outputs.version }}.dmg
              asset_content_type: application/x-apple-diskimage
